#!/bin/bash

MODE="shell"
PERCENTAGE="$(pmset -g ps | egrep -o '[0-9]+%' | tr -d %)"
DISPLAY="${PERCENTAGE}%"

function get_percentage() {
  echo "$(pmset -g ps | egrep -o '[0-9]+%' | tr -d %)"
}

function is_charging() {
  pmset -g ps | grep -E "Battery Power|charged" >/dev/null 2>&1
  if [ $? -eq 0 ]; then
    return 1
  else
    return 0
  fi
}

get_remain() {
  local time_remain
  time_remain="$(pmset -g ps | grep -o '[0-9]\+:[0-9]\+')"
  if [ -z "$time_remain" ]; then
    time_remain="no estimate"
  fi
  echo "$time_remain"
}

function get_meter() {
  if is_charging; then
    echo '|⚡︎⚡︎⚡︎⚡︎⚡︎|'
  else
    if [ $PERCENTAGE -le 20 ]; then
      echo '|█    |'
    elif [ $PERCENTAGE -gt 20 ] && [ $PERCENTAGE -le 40 ]; then
      echo '|██   |'
    elif [ $PERCENTAGE -gt 40 ] && [ $PERCENTAGE -le 60 ]; then
      echo '|███  |'
    elif [ $PERCENTAGE -gt 60 ] && [ $PERCENTAGE -le 80 ]; then
      echo '|████ |'
    elif [ $PERCENTAGE -gt 80 ] && [ $PERCENTAGE -le 100 ]; then
      echo '|█████|'
    fi
  fi
}

# display() {
  # if is_charging; then
    # echo -e "\033[32m$PCT_BLOCK\033[m"
  # else
    # if [ $PCT -lt 20 ]; then
      # echo -e "\033[31m$PCT_BLOCK\033[m"
    # else
      # echo -e "\033[34m$PCT_BLOCK\033[m"
    # fi
  # fi
# }

# function get_color() {
  # if is_charging; then
    # echo "colour2"
  # else
    # if [ $PERCENTAGE -lt 20 ]; then
      # echo "red"
    # else
      # echo "blue"
    # fi
  # fi
# }

function display() {
  if [ ${MODE} == "shell" ]; then
    if is_charging; then
      echo -e "\033[32m${DISPLAY}\033[m"
    else
      if [ $PERCENTAGE -lt 20 ]; then
        echo -e "\033[31m${DISPLAY}\033[m"
      else
        echo -e "\033[34m${DISPLAY}\033[m"
      fi
    fi
  elif [ ${MODE} == "tmux" ]; then
    if is_charging; then
      echo -e "#[fg=colour2]${DISPLAY}#[default]"
    else
      if [ $PERCENTAGE -lt 20 ]; then
        echo -e "#[fg=red]${DISPLAY}#[default]"
      else
        echo -e "#[fg=blue]${DISPLAY}#[default]"
      fi
    fi
  fi
}

for i in "$@"
do
  case "$i" in
    "-h")
      # echo "usage: battery [-t tmux][-p percentage][-m meter][-r remain]" 1>&2
      echo "usage: battery [-t tmux][-m meter][-r remain]" 1>&2
      exit
      ;;
    "-t")
      MODE="tmux"
      ;;
    # "-p")
      # DISPLAY="${DISPLAY}${PERCENTAGE}% "
      # ;;
    "-m")
      DISPLAY="${DISPLAY} $(get_meter)"
      ;;
    "-r")
      DISPLAY="${DISPLAY} ($(get_remain))"
      ;;
    -*)
      echo "$i: unknown option" 1>&2
      exit 1
      ;;
  esac
done
# echo -e "#[fg=$(get_color)]${DISPLAY}#[default]"
display

